local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

local ClientGizmos = require(game:GetService("ReplicatedStorage").Client.Wanted.Modules.ClientGizmos)
local GizmoData = debug.getupvalue(ClientGizmos.Get, 1)

local Settings = {
    Enabled = true,
    MaxDistance = 5000,
    BoxThickness = 1,
    BoxColor = Color3.fromRGB(255, 255, 255),
    IdColor = Color3.fromRGB(200, 200, 255),
    DistanceColor = Color3.fromRGB(200, 200, 200),
    TextSize = 13,
}

local Esp = {}

local function GetRoot()
    local Character = LocalPlayer.Character
    return Character and Character:FindFirstChild("HumanoidRootPart")
end

local function GetModel(Gizmo)
    if Gizmo.model then
        return Gizmo.model
    end
    for _, Model in ipairs(workspace.Local.Gizmos:GetDescendants()) do
        if Model:IsA("Model") and Model:GetAttribute("objectId") == Gizmo.objectId then
            return Model
        end
    end
end

local function CreateBox()
    local Lines = {}
    for i = 1, 4 do
        local Line = Drawing.new("Line")
        Line.Visible = false
        Line.Color = Settings.BoxColor
        Line.Thickness = Settings.BoxThickness
        Lines[i] = Line
    end
    return Lines
end

local function GetDisplayId(Gizmo)
    return (
        Gizmo.properties
        and Gizmo.properties.toolStateOverride
        and Gizmo.properties.toolStateOverride.name
    )
    or Gizmo.name
    or Gizmo.gizmoType
    or tostring(Gizmo.objectId)
end

local function CreateEsp(Gizmo)
    if Esp[Gizmo.objectId] then return end

    local Model = GetModel(Gizmo)
    if not Model then return end

    local Part =
        Model.PrimaryPart
        or Model:FindFirstChildWhichIsA("BasePart")
    if not Part then return end

    local Box = CreateBox()

    local IdText = Drawing.new("Text")
    IdText.Visible = false
    IdText.Center = true
    IdText.Outline = true
    IdText.Size = Settings.TextSize
    IdText.Color = Settings.IdColor
    IdText.Font = 2

    local DistanceText = Drawing.new("Text")
    DistanceText.Visible = false
    DistanceText.Center = true
    DistanceText.Outline = true
    DistanceText.Size = Settings.TextSize
    DistanceText.Color = Settings.DistanceColor
    DistanceText.Font = 2

    Esp[Gizmo.objectId] = {
        Gizmo = Gizmo,
        Model = Model,
        Part = Part,
        Box = Box,
        Id = IdText,
        Distance = DistanceText,
    }
end

local function RemoveEsp(Id)
    local Entry = Esp[Id]
    if not Entry then return end

    for _, Line in ipairs(Entry.Box) do
        Line:Remove()
    end
    Entry.Id:Remove()
    Entry.Distance:Remove()

    Esp[Id] = nil
end

local function UpdateEsp()
    if not Settings.Enabled then return end

    local Root = GetRoot()
    if not Root then return end

    for _, Gizmo in pairs(GizmoData) do
        if Gizmo and Gizmo.objectId then
            CreateEsp(Gizmo)

            local Entry = Esp[Gizmo.objectId]
            if Entry then
                local Cf = Entry.Part.CFrame
                local Size = Entry.Model:GetExtentsSize()

                local ScreenPos, OnScreen =
                    Camera:WorldToViewportPoint(Cf.Position)
                if not OnScreen then
                    for _, Line in ipairs(Entry.Box) do Line.Visible = false end
                    Entry.Id.Visible = false
                    Entry.Distance.Visible = false
                    continue
                end

                local Dist = (Root.Position - Cf.Position).Magnitude
                if Settings.MaxDistance and Dist > Settings.MaxDistance then
                    for _, Line in ipairs(Entry.Box) do Line.Visible = false end
                    Entry.Id.Visible = false
                    Entry.Distance.Visible = false
                    continue
                end

                local Top =
                    Camera:WorldToViewportPoint(
                        (Cf * CFrame.new(0, Size.Y / 2, 0)).Position
                    )
                local Bottom =
                    Camera:WorldToViewportPoint(
                        (Cf * CFrame.new(0, -Size.Y / 2, 0)).Position
                    )

                local Height = Bottom.Y - Top.Y
                local Width = Height * 0.65

                local X = Top.X - Width / 2
                local Y = Top.Y

                local TL = Vector2.new(X, Y)
                local TR = Vector2.new(X + Width, Y)
                local BL = Vector2.new(X, Y + Height)
                local BR = Vector2.new(X + Width, Y + Height)

                local Box = Entry.Box
                Box[1].From, Box[1].To = TL, TR
                Box[2].From, Box[2].To = TR, BR
                Box[3].From, Box[3].To = BR, BL
                Box[4].From, Box[4].To = BL, TL

                for _, Line in ipairs(Box) do
                    Line.Visible = true
                end

                Entry.Id.Text = tostring(GetDisplayId(Gizmo))
                Entry.Id.Position = Vector2.new(Top.X, Y + Height + 2)
                Entry.Id.Visible = true

                Entry.Distance.Text = string.format("%d studs", Dist)
                Entry.Distance.Position =
                    Vector2.new(Top.X, Y + Height + 2 + Settings.TextSize + 2)
                Entry.Distance.Visible = true
            end
        end
    end

    for Id in pairs(Esp) do
        if not GizmoData[Id] then
            RemoveEsp(Id)
        end
    end
end

RunService.RenderStepped:Connect(UpdateEsp)
